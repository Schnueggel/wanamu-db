build:
  box: postgres
  steps:
    - script:
        name: make dirs
        code: |
          mkdir /var/lib/postgresql/dump
          cp ./scripts/initdb.sh /docker-entrypoint-initdb.d/
          rm -rf /scripts
          cp -r ./scripts /scripts
          rm -rf /changelogs
          cp -r ./changelogs /changelogs
deploy:
  box: ubuntu:latest
  steps:
    - internal/docker-push:
        username: golio
        password: $WANAMU_REGISTRY_PASSWORD
        repository: golio/test
        tag: latest
        registry: https://registry.hub.docker.com
    - add-ssh-key:
        keyname: OVH_KEY
    - script:
        name: install ssh
        code: |
          apt-get --yes --force-yes install ssh openssh-client
          ssh-agent -s
    - script:
        name: scp install
        code: |
          scp  -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $WERCKER_ROOT/install.sh $WANAMU_REGISTRY_USER@$DEPLOY_HOST:/home/$WANAMU_REGISTRY_USER/
    - script:
        name: deploy the image
        code: |
          ssh -l wercker -o UserKnownHostsFile=/dev/null -t -o StrictHostKeyChecking=no $DEPLOY_HOST <<EOF
          docker login -u $WANAMU_REGISTRY_USER -p $WANAMU_REGISTRY_PASSWORD $WANAMU_REGISTRY
          echo "pulling $WANAMU_REGISTRY_URL/$WANAMU_REGISTRY_USER/$WANAMU_DB_REPO"
          docker pull $WANAMU_REGISTRY_URL/$WANAMU_REGISTRY_USER/$WANAMU_DB_REPO
          EOF