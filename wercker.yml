build:
  box: postgres
  steps:
    - script:
        name: make dirs
        code: |
          mkdir /var/lib/postgresql/dump
          cp ./scripts/initdb.sh /docker-entrypoint-initdb.d/
          rm -rf /scripts
          cp -r ./scripts /scripts
          rm -rf /changelogs
          cp -r ./changelogs /changelogs
deploy:
  box: ubuntu:latest
  steps:
    - internal/docker-push:
        username: $WANAMU_REGISTRY_USER
        password: $WANAMU_REGISTRY_PASSWORD
        repository: $WANAMU_DB_REPO
        tag: $WERCKER_GIT_COMMIT
        registry: $WANAMU_REGISTRY
    - add-ssh-key:
        keyname: OVH_KEY
    - script:
        name: stop application
        code: |
          export
          apt-get --yes --force-yes install openssh-client
          ssh-agent -s
          ssh -l wercker -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $DEPLOY_HOST sudo touch ~/test
